{% extends "base.html" %}

{% block title %}Dashboard{% endblock %}

{% block extra_css %}
<style>
    .file-list {
        max-height: 400px;
        overflow-y: auto;
    }
    .connection-status {
        position: fixed;
        bottom: 20px;
        right: 20px;
        z-index: 1000;
    }
</style>
{% endblock %}

{% block content %}
<div class="container">
    <div class="row">
        <div class="col-md-12">
            <div class="card">
                <div class="card-header d-flex justify-content-between align-items-center">
                    <h5 class="mb-0">Files</h5>
                    <div>
                        <span id="connectionStatus" class="badge bg-secondary me-2">Checking connection...</span>
                        <button class="btn btn-primary btn-sm" onclick="refreshFiles()">
                            <i class="bi bi-arrow-clockwise"></i> Refresh
                        </button>
                        <form action="/upload_files" method="post" enctype="multipart/form-data" class="d-inline">
                            <input type="file" name="file" id="file" class="d-none" onchange="this.form.submit()">
                            <button type="button" class="btn btn-success btn-sm" onclick="document.getElementById('file').click()">
                                <i class="bi bi-upload"></i> Upload
                            </button>
                        </form>
                    </div>
                </div>
                <div class="card-body file-list">
                    <div id="fileList" class="list-group">
                        <!-- Files will be listed here -->
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
async function refreshFiles() {
    try {
        const response = await fetch('/list-files');
        if (!response.ok) {
            throw new Error(`HTTP error! status: ${response.status}`);
        }
        const data = await response.json();
        const fileList = document.getElementById('fileList');
        fileList.innerHTML = '';

        // Verificar que data y data.files existen
        if (!data || !data.files) {
            fileList.innerHTML = '<div class="list-group-item">Error loading files</div>';
            return;
        }

        if (data.files.length === 0) {
            fileList.innerHTML = '<div class="list-group-item">No files uploaded yet</div>';
            return;
        }

        data.files.forEach(file => {
            const item = document.createElement('div');
            item.className = 'list-group-item d-flex justify-content-between align-items-center';
            item.innerHTML = `
                <span>${file}</span>
                <div class="btn-group">
                    <button class="btn btn-primary btn-sm" onclick="downloadFile('${file}')">
                        <i class="bi bi-download"></i> Download
                    </button>
                    <button class="btn btn-danger btn-sm" onclick="deleteFile('${file}')">
                        <i class="bi bi-trash"></i> Delete
                    </button>
                </div>
            `;
            fileList.appendChild(item);
        });
    } catch (error) {
        console.error('Error loading files:', error);
        const fileList = document.getElementById('fileList');
        fileList.innerHTML = '<div class="list-group-item text-danger">Error loading files: ' + error.message + '</div>';
    }
}

async function downloadFile(fileName) {
    try {
        const response = await fetch(`/download/${fileName}`, {
            method: 'POST'
        });
        const data = await response.json();
        
        if (response.ok) {
            alert('Download command sent to agent successfully');
        } else {
            const errorMsg = data.detail || data.message || 'Error sending download command';
            alert(`Error: ${errorMsg}`);
        }
    } catch (error) {
        console.error('Error downloading file:', error);
        alert('Error downloading file: Network error');
    }
}

async function deleteFile(fileName) {
    if (!confirm(`Are you sure you want to delete ${fileName}?`)) {
        return;
    }
    
    try {
        const response = await fetch(`/files/${fileName}`, {
            method: 'DELETE'
        });
        const data = await response.json();
        
        if (data.status === 'success') {
            refreshFiles();
        } else {
            alert(data.message || 'Error deleting file');
        }
    } catch (error) {
        console.error('Error deleting file:', error);
        alert('Error deleting file');
    }
}

let ws = null;

function updateAgentStatus(connected) {
    const statusBadge = document.getElementById('connectionStatus');
    if (connected) {
        statusBadge.className = 'badge bg-success me-2';
        statusBadge.textContent = 'Connected';
    } else {
        statusBadge.className = 'badge bg-danger me-2';
        statusBadge.textContent = 'Disconnected';
    }
}

function connectWebSocket() {
    ws = new WebSocket(`ws://${window.location.host}/ws`);
    
    ws.onopen = () => {
        // Al conectar, preguntar por el estado del agente
        ws.send(JSON.stringify({
            type: 'command',
            command: 'ping'
        }));
    };
    
    ws.onclose = () => {
        updateAgentStatus(false);
        // Intentar reconectar en 5 segundos
        setTimeout(connectWebSocket, 5000);
    };
    
    ws.onmessage = (event) => {
        const data = JSON.parse(event.data);
        console.log('WebSocket message:', data); // Para debug
        
        if (data.type === 'agent_status') {
            updateAgentStatus(data.connected);
        } else if (data.type === 'error' && data.message === 'No hay agentes conectados') {
            updateAgentStatus(false);
        } else if (data.type === 'response' && data.status === 'ok') {
            updateAgentStatus(true);
        }
    };
}

// Comprobar el estado del agente cada 10 segundos
function checkAgentStatus() {
    if (ws && ws.readyState === WebSocket.OPEN) {
        ws.send(JSON.stringify({
            type: 'command',
            command: 'ping'
        }));
    }
}

document.addEventListener('DOMContentLoaded', () => {
    connectWebSocket();
    setInterval(checkAgentStatus, 10000);
    refreshFiles();
    setInterval(refreshFiles, 5000);
});
</script>
{% endblock %}
