{% extends "base.html" %}

{% block title %}Dashboard{% endblock %}

{% block extra_css %}
<style>
    .file-list {
        max-height: 400px;
        overflow-y: auto;
    }
    .connection-status {
        position: fixed;
        bottom: 20px;
        right: 20px;
        z-index: 1000;
    }
</style>
{% endblock %}

{% block content %}
<div class="container">
    <div class="row">
        <div class="col-md-12">
            <div id="connectionStatus" class="connection-status">
                <span class="badge bg-secondary">Checking connection...</span>
            </div>

            <div class="card">
                <div class="card-header d-flex justify-content-between align-items-center">
                    <h4 class="mb-0">Files</h4>
                    <div>
                        <button class="btn btn-primary btn-sm" onclick="refreshFiles()">
                            <i class="bi bi-arrow-clockwise"></i> Refresh
                        </button>
                        <form action="/upload" method="post" enctype="multipart/form-data" class="d-inline">
                            <input type="file" name="file" id="file" class="d-none" onchange="this.form.submit()">
                            <button type="button" class="btn btn-success btn-sm" onclick="document.getElementById('file').click()">
                                <i class="bi bi-upload"></i> Upload
                            </button>
                        </form>
                    </div>
                </div>
                <div class="card-body file-list">
                    <div id="fileList" class="list-group">
                        <!-- Files will be listed here -->
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
async function refreshFiles() {
    try {
        const response = await fetch('/list-files');
        const data = await response.json();
        const fileList = document.getElementById('fileList');
        fileList.innerHTML = '';

        if (data.files.length === 0) {
            fileList.innerHTML = '<div class="list-group-item">No files uploaded yet</div>';
            return;
        }

        data.files.forEach(file => {
            const item = document.createElement('div');
            item.className = 'list-group-item d-flex justify-content-between align-items-center';
            item.innerHTML = `
                <span>${file}</span>
                <div class="btn-group">
                    <button class="btn btn-primary btn-sm" onclick="downloadFile('${file}')">
                        <i class="bi bi-download"></i> Download
                    </button>
                    <button class="btn btn-danger btn-sm" onclick="deleteFile('${file}')">
                        <i class="bi bi-trash"></i> Delete
                    </button>
                </div>
            `;
            fileList.appendChild(item);
        });
    } catch (error) {
        console.error('Error loading files:', error);
    }
}

async function downloadFile(fileName) {
    try {
        const response = await fetch(`/download/${fileName}`, {
            method: 'POST'
        });
        const data = await response.json();
        
        if (response.ok) {
            alert('Download command sent to agent successfully');
        } else {
            const errorMsg = data.detail || data.message || 'Error sending download command';
            alert(`Error: ${errorMsg}`);
        }
    } catch (error) {
        console.error('Error downloading file:', error);
        alert('Error downloading file: Network error');
    }
}

async function deleteFile(fileName) {
    if (!confirm(`Are you sure you want to delete ${fileName}?`)) {
        return;
    }
    
    try {
        const response = await fetch(`/files/${fileName}`, {
            method: 'DELETE'
        });
        const data = await response.json();
        
        if (data.status === 'success') {
            refreshFiles();
        } else {
            alert(data.message || 'Error deleting file');
        }
    } catch (error) {
        console.error('Error deleting file:', error);
        alert('Error deleting file');
    }
}

// Load files immediately and every 5 seconds
refreshFiles();
setInterval(refreshFiles, 5000);

// Check connection status periodically
setInterval(() => {
    fetch('/list-files')
        .then(() => {
            document.getElementById('connectionStatus').innerHTML = `
                <span class="badge bg-success">Connected</span>
            `;
        })
        .catch(() => {
            document.getElementById('connectionStatus').innerHTML = `
                <span class="badge bg-danger">Disconnected</span>
            `;
        });
}, 5000);
</script>
{% endblock %}
